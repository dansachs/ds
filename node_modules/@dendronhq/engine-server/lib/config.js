"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DConfig = exports.ConfigUtils = void 0;
const common_all_1 = require("@dendronhq/common-all");
const common_server_1 = require("@dendronhq/common-server");
const fs_extra_1 = __importDefault(require("fs-extra"));
const lodash_1 = __importDefault(require("lodash"));
const path_1 = __importDefault(require("path"));
class ConfigUtils {
    static usePrettyRef(config) {
        var _a;
        let usePrettyRefs = lodash_1.default.find([config === null || config === void 0 ? void 0 : config.usePrettyRefs, (_a = config === null || config === void 0 ? void 0 : config.site) === null || _a === void 0 ? void 0 : _a.usePrettyRefs], (ent) => !lodash_1.default.isUndefined(ent));
        if (lodash_1.default.isUndefined(usePrettyRefs)) {
            usePrettyRefs = true;
        }
        return usePrettyRefs;
    }
}
exports.ConfigUtils = ConfigUtils;
class DConfig {
    static configPath(configRoot) {
        return path_1.default.join(configRoot, common_all_1.CONSTANTS.DENDRON_CONFIG_FILE);
    }
    static defaults(config) {
        return lodash_1.default.defaults(config, { initializeRemoteVaults: true });
    }
    static genDefaultConfig() {
        return {
            version: 1,
            vaults: [],
            useFMTitle: true,
            useNoteTitleForLink: true,
            noAutoCreateOnDefinition: true,
            noLegacyNoteRef: true,
            noXVaultWikiLink: true,
            lookupConfirmVaultOnCreate: false,
            journal: {
                dailyDomain: "daily",
                name: "journal",
                dateFormat: "y.MM.dd",
                addBehavior: common_all_1.NoteAddBehavior.childOfDomain,
                firstDayOfWeek: 1,
            },
            site: {
                copyAssets: true,
                siteHierarchies: ["root"],
                siteRootDir: "docs",
                usePrettyRefs: true,
                title: "Dendron",
                description: "Personal knowledge space",
            },
        };
    }
    /**
     * Get without filling in defaults
     * @param wsRoot
     */
    static getRaw(wsRoot) {
        const configPath = DConfig.configPath(wsRoot);
        const config = common_server_1.readYAML(configPath);
        return config;
    }
    static getOrCreate(dendronRoot, defaults) {
        const configPath = DConfig.configPath(dendronRoot);
        let config;
        if (!fs_extra_1.default.existsSync(configPath)) {
            config = { ...defaults, ...DConfig.genDefaultConfig() };
            common_server_1.writeYAML(configPath, config);
        }
        else {
            config = common_server_1.readYAML(configPath);
        }
        return config;
    }
    /**
     * Get config value with consideration for defaults
     * @param config
     */
    static getProp(config, key) {
        const cConfig = lodash_1.default.defaults(config, this.genDefaultConfig());
        return cConfig[key];
    }
    static getSiteIndex(sconfig) {
        let { siteIndex, siteHierarchies } = sconfig;
        return siteIndex || siteHierarchies[0];
    }
    /**
     * fill in defaults
     */
    static cleanSiteConfig(config) {
        let out = lodash_1.default.defaults(config, {
            copyAssets: true,
            usePrettyRefs: true,
            siteNotesDir: "notes",
            siteFaviconPath: "favicon.ico",
            gh_edit_link: true,
            gh_edit_link_text: "Edit this page on GitHub",
            gh_edit_branch: "master",
            gh_root: "docs/",
            gh_edit_view_mode: "edit",
            writeStubs: true,
            description: "Personal knowledge space",
        });
        let { siteRootDir, siteHierarchies, siteIndex, siteUrl } = out;
        if (process.env["SITE_URL"]) {
            siteUrl = process.env["SITE_URL"];
        }
        if (!siteRootDir) {
            throw `siteRootDir is undefined`;
        }
        if (!siteUrl && common_all_1.getStage() === "dev") {
            // this gets overridden in dev so doesn't matter
            siteUrl = "https://foo";
        }
        if (!siteUrl) {
            throw common_all_1.DendronError.createFromStatus({
                status: common_all_1.ERROR_STATUS.INVALID_CONFIG,
                message: "siteUrl is undefined. See https://dendron.so/notes/f2ed8639-a604-4a9d-b76c-41e205fb8713.html#siteurl for more details",
            });
        }
        if (lodash_1.default.size(siteHierarchies) < 1) {
            throw common_all_1.DendronError.createFromStatus({
                status: common_all_1.ERROR_STATUS.INVALID_CONFIG,
                message: `siteHiearchies must have at least one hiearchy`,
            });
        }
        siteIndex = this.getSiteIndex(config);
        return {
            ...out,
            siteIndex,
            siteUrl,
        };
    }
    static writeConfig({ wsRoot, config, }) {
        const configPath = DConfig.configPath(wsRoot);
        return common_server_1.writeYAML(configPath, config);
    }
}
exports.DConfig = DConfig;
//# sourceMappingURL=config.js.map